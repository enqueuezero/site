<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Message Queue Use Case | Enqueue Zero</title>
    <meta name="generator" content="VuePress 1.9.5">
    
    <meta name="description" content="Enqueue Zero is publishing code principles.">
    
    <link rel="preload" href="/assets/css/0.styles.107744cb.css" as="style"><link rel="preload" href="/assets/js/app.5635613a.js" as="script"><link rel="preload" href="/assets/js/6.34f786ca.js" as="script"><link rel="preload" href="/assets/js/62.473c2104.js" as="script"><link rel="prefetch" href="/assets/js/1.2cd4f664.js"><link rel="prefetch" href="/assets/js/10.596d2f91.js"><link rel="prefetch" href="/assets/js/100.42ab8b08.js"><link rel="prefetch" href="/assets/js/101.3edec124.js"><link rel="prefetch" href="/assets/js/102.1dcb75f1.js"><link rel="prefetch" href="/assets/js/103.411d1d12.js"><link rel="prefetch" href="/assets/js/104.3db5fe2f.js"><link rel="prefetch" href="/assets/js/105.e970afee.js"><link rel="prefetch" href="/assets/js/106.2af29901.js"><link rel="prefetch" href="/assets/js/107.40824ebd.js"><link rel="prefetch" href="/assets/js/108.19e001ef.js"><link rel="prefetch" href="/assets/js/109.26bc9d1f.js"><link rel="prefetch" href="/assets/js/11.819e951d.js"><link rel="prefetch" href="/assets/js/110.b268c087.js"><link rel="prefetch" href="/assets/js/111.25ed91a6.js"><link rel="prefetch" href="/assets/js/112.62fa7bcd.js"><link rel="prefetch" href="/assets/js/113.c3b96843.js"><link rel="prefetch" href="/assets/js/114.3444f8a3.js"><link rel="prefetch" href="/assets/js/115.50aa8811.js"><link rel="prefetch" href="/assets/js/116.7776d4ab.js"><link rel="prefetch" href="/assets/js/117.3b8fa782.js"><link rel="prefetch" href="/assets/js/118.06236655.js"><link rel="prefetch" href="/assets/js/119.32923994.js"><link rel="prefetch" href="/assets/js/12.40dea1e6.js"><link rel="prefetch" href="/assets/js/120.1f801e93.js"><link rel="prefetch" href="/assets/js/121.5882274f.js"><link rel="prefetch" href="/assets/js/122.19519db9.js"><link rel="prefetch" href="/assets/js/123.50c58a5f.js"><link rel="prefetch" href="/assets/js/124.094762a4.js"><link rel="prefetch" href="/assets/js/125.1c410e15.js"><link rel="prefetch" href="/assets/js/126.304889e6.js"><link rel="prefetch" href="/assets/js/127.6d735ade.js"><link rel="prefetch" href="/assets/js/128.aa2408c5.js"><link rel="prefetch" href="/assets/js/129.a116a668.js"><link rel="prefetch" href="/assets/js/13.c53bdb4c.js"><link rel="prefetch" href="/assets/js/130.94476043.js"><link rel="prefetch" href="/assets/js/131.39799d04.js"><link rel="prefetch" href="/assets/js/132.18d4d569.js"><link rel="prefetch" href="/assets/js/133.cfd7707b.js"><link rel="prefetch" href="/assets/js/134.f715d2a1.js"><link rel="prefetch" href="/assets/js/135.aa974d8c.js"><link rel="prefetch" href="/assets/js/136.98059fc9.js"><link rel="prefetch" href="/assets/js/137.8bdc36f5.js"><link rel="prefetch" href="/assets/js/138.337cf774.js"><link rel="prefetch" href="/assets/js/139.9d630070.js"><link rel="prefetch" href="/assets/js/14.915da388.js"><link rel="prefetch" href="/assets/js/140.782b9004.js"><link rel="prefetch" href="/assets/js/141.2e97a76f.js"><link rel="prefetch" href="/assets/js/142.e37820d6.js"><link rel="prefetch" href="/assets/js/143.a3c926a1.js"><link rel="prefetch" href="/assets/js/144.925d6cd5.js"><link rel="prefetch" href="/assets/js/145.76620ad5.js"><link rel="prefetch" href="/assets/js/146.ac40299a.js"><link rel="prefetch" href="/assets/js/147.de8b1eb1.js"><link rel="prefetch" href="/assets/js/148.a4d93421.js"><link rel="prefetch" href="/assets/js/149.33a78104.js"><link rel="prefetch" href="/assets/js/15.dd69fcbd.js"><link rel="prefetch" href="/assets/js/150.29e0e69f.js"><link rel="prefetch" href="/assets/js/151.acc70e30.js"><link rel="prefetch" href="/assets/js/152.dc4dbbb2.js"><link rel="prefetch" href="/assets/js/153.81d1d4f9.js"><link rel="prefetch" href="/assets/js/154.81218a9f.js"><link rel="prefetch" href="/assets/js/155.6070ab36.js"><link rel="prefetch" href="/assets/js/156.712eaf4a.js"><link rel="prefetch" href="/assets/js/157.73e6a015.js"><link rel="prefetch" href="/assets/js/158.93b2f91f.js"><link rel="prefetch" href="/assets/js/159.9a07fb6f.js"><link rel="prefetch" href="/assets/js/16.65cae841.js"><link rel="prefetch" href="/assets/js/160.a8c2a9a8.js"><link rel="prefetch" href="/assets/js/161.09a5a309.js"><link rel="prefetch" href="/assets/js/162.63fa236c.js"><link rel="prefetch" href="/assets/js/163.4b595e7b.js"><link rel="prefetch" href="/assets/js/164.6559d542.js"><link rel="prefetch" href="/assets/js/17.e8328420.js"><link rel="prefetch" href="/assets/js/18.257a5bf1.js"><link rel="prefetch" href="/assets/js/19.c7373bf3.js"><link rel="prefetch" href="/assets/js/2.b1baa485.js"><link rel="prefetch" href="/assets/js/20.dc0381f7.js"><link rel="prefetch" href="/assets/js/21.e9cbb3ad.js"><link rel="prefetch" href="/assets/js/22.32c588f3.js"><link rel="prefetch" href="/assets/js/23.e5520314.js"><link rel="prefetch" href="/assets/js/24.ff91ac23.js"><link rel="prefetch" href="/assets/js/25.8288b017.js"><link rel="prefetch" href="/assets/js/26.00e9f3fd.js"><link rel="prefetch" href="/assets/js/27.3c053ddc.js"><link rel="prefetch" href="/assets/js/28.4d2b77ad.js"><link rel="prefetch" href="/assets/js/29.a0f26c7d.js"><link rel="prefetch" href="/assets/js/3.76446aa7.js"><link rel="prefetch" href="/assets/js/30.d38ec5d1.js"><link rel="prefetch" href="/assets/js/31.aaceb5f0.js"><link rel="prefetch" href="/assets/js/32.fe2aa3ec.js"><link rel="prefetch" href="/assets/js/33.0ab3373f.js"><link rel="prefetch" href="/assets/js/34.87a27376.js"><link rel="prefetch" href="/assets/js/35.60addafc.js"><link rel="prefetch" href="/assets/js/36.974487b2.js"><link rel="prefetch" href="/assets/js/37.2c9430a1.js"><link rel="prefetch" href="/assets/js/38.a1d8340f.js"><link rel="prefetch" href="/assets/js/39.3097f16b.js"><link rel="prefetch" href="/assets/js/4.59a84be5.js"><link rel="prefetch" href="/assets/js/40.02810afa.js"><link rel="prefetch" href="/assets/js/41.3cb2be87.js"><link rel="prefetch" href="/assets/js/42.907d9958.js"><link rel="prefetch" href="/assets/js/43.4c02b324.js"><link rel="prefetch" href="/assets/js/44.fc733234.js"><link rel="prefetch" href="/assets/js/45.9a380634.js"><link rel="prefetch" href="/assets/js/46.16d3d13f.js"><link rel="prefetch" href="/assets/js/47.da77cce1.js"><link rel="prefetch" href="/assets/js/48.15b33233.js"><link rel="prefetch" href="/assets/js/49.e1c9c3f2.js"><link rel="prefetch" href="/assets/js/50.7f29d884.js"><link rel="prefetch" href="/assets/js/51.a0d2ce96.js"><link rel="prefetch" href="/assets/js/52.70c27a3b.js"><link rel="prefetch" href="/assets/js/53.b0254d40.js"><link rel="prefetch" href="/assets/js/54.ad28d446.js"><link rel="prefetch" href="/assets/js/55.b396add9.js"><link rel="prefetch" href="/assets/js/56.abe73194.js"><link rel="prefetch" href="/assets/js/57.3a5fb486.js"><link rel="prefetch" href="/assets/js/58.831ad661.js"><link rel="prefetch" href="/assets/js/59.f9a824d5.js"><link rel="prefetch" href="/assets/js/60.b41ba5e5.js"><link rel="prefetch" href="/assets/js/61.6f97e2e2.js"><link rel="prefetch" href="/assets/js/63.bba07182.js"><link rel="prefetch" href="/assets/js/64.4f7e2e99.js"><link rel="prefetch" href="/assets/js/65.92a7981c.js"><link rel="prefetch" href="/assets/js/66.f700a5d0.js"><link rel="prefetch" href="/assets/js/67.a04cc74f.js"><link rel="prefetch" href="/assets/js/68.558e69ec.js"><link rel="prefetch" href="/assets/js/69.f8566b86.js"><link rel="prefetch" href="/assets/js/7.940b93e1.js"><link rel="prefetch" href="/assets/js/70.b84c1ba5.js"><link rel="prefetch" href="/assets/js/71.c592eea4.js"><link rel="prefetch" href="/assets/js/72.47475b5e.js"><link rel="prefetch" href="/assets/js/73.89979226.js"><link rel="prefetch" href="/assets/js/74.0bed6656.js"><link rel="prefetch" href="/assets/js/75.ddf6341d.js"><link rel="prefetch" href="/assets/js/76.c61e4737.js"><link rel="prefetch" href="/assets/js/77.d440a7c2.js"><link rel="prefetch" href="/assets/js/78.ad55758d.js"><link rel="prefetch" href="/assets/js/79.70797d1c.js"><link rel="prefetch" href="/assets/js/8.d6bdbbeb.js"><link rel="prefetch" href="/assets/js/80.8d3fce1f.js"><link rel="prefetch" href="/assets/js/81.f9753d5f.js"><link rel="prefetch" href="/assets/js/82.ce06fbed.js"><link rel="prefetch" href="/assets/js/83.35dd228b.js"><link rel="prefetch" href="/assets/js/84.7c74e761.js"><link rel="prefetch" href="/assets/js/85.e6e87755.js"><link rel="prefetch" href="/assets/js/86.491915b8.js"><link rel="prefetch" href="/assets/js/87.a445b89c.js"><link rel="prefetch" href="/assets/js/88.ebf09381.js"><link rel="prefetch" href="/assets/js/89.3509306c.js"><link rel="prefetch" href="/assets/js/9.a5f0806e.js"><link rel="prefetch" href="/assets/js/90.e903c03f.js"><link rel="prefetch" href="/assets/js/91.0a541e81.js"><link rel="prefetch" href="/assets/js/92.63708df0.js"><link rel="prefetch" href="/assets/js/93.f4bccd30.js"><link rel="prefetch" href="/assets/js/94.261a27c5.js"><link rel="prefetch" href="/assets/js/95.8c116fed.js"><link rel="prefetch" href="/assets/js/96.a8755466.js"><link rel="prefetch" href="/assets/js/97.d526403a.js"><link rel="prefetch" href="/assets/js/98.dce07d88.js"><link rel="prefetch" href="/assets/js/99.5daa9d38.js">
    <link rel="stylesheet" href="/assets/css/0.styles.107744cb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Enqueue Zero</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/soasme/enqueuezero" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/soasme/enqueuezero" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="message-queue-use-case"><a href="#message-queue-use-case" class="header-anchor">#</a> Message Queue Use Case</h1> <p>Imagine you are developing a website that allows user to register. After submiting user's email and password hash to database, the user will need to verify his account by clicking a link that is sent to his email inbox.</p> <p>Initially, you might wrote below code.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># app.py</span>
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> g<span class="token punctuation">,</span> render_template
<span class="token keyword">from</span> flask_mail <span class="token keyword">import</span> Mail<span class="token punctuation">,</span> Message

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
mail <span class="token operator">=</span> Mail<span class="token punctuation">(</span>app<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">send_account_verification_mail</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
    msg <span class="token operator">=</span> Message<span class="token punctuation">(</span>
        <span class="token string">&quot;Congratulations, you are a member of %s now.&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>
            app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'SITE_NAME'</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        body<span class="token operator">=</span><span class="token string">'Please click the link: %s'</span> <span class="token operator">%</span> get_verification_link<span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">,</span>
        sender<span class="token operator">=</span><span class="token string">&quot;noreply@example.com&quot;</span><span class="token punctuation">,</span>
        recipients<span class="token operator">=</span><span class="token punctuation">[</span>user<span class="token punctuation">.</span>email<span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
    mail<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/users/register/success'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">register_account_success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    send_account_verification_mail<span class="token punctuation">(</span>g<span class="token punctuation">.</span>user<span class="token punctuation">)</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'users/register/success.html'</span><span class="token punctuation">)</span>
</code></pre></div><p>The code looks about to be right, except it will take several seconds until the page is loaded. If the email vendor is experiencing some performance issues or, even worse, complete outage, the page could seem to load forever.</p> <p>Message queue to resue! You decide to deploy a RabbitMQ instance and some workers that run in the background.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># start rabbitmq server</span>
<span class="token comment"># assume rabbitmq has installed</span>
$ <span class="token function">service</span> rabbitmq-server start

<span class="token comment"># start the worker</span>
$ celery -A app.celery worker
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># app.py</span>
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> g<span class="token punctuation">,</span> render_template
<span class="token keyword">from</span> flask_mail <span class="token keyword">import</span> Mail<span class="token punctuation">,</span> Message
<span class="token keyword">from</span> celery <span class="token keyword">import</span> Celery

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
mail <span class="token operator">=</span> Mail<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
celery <span class="token operator">=</span> Celery<span class="token punctuation">(</span>
    app<span class="token punctuation">.</span>import_name<span class="token punctuation">,</span>
    broker<span class="token operator">=</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'CELERY_BROKER_URL'</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@celery<span class="token punctuation">.</span>task</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">send_account_verification_mail</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
    msg <span class="token operator">=</span> Message<span class="token punctuation">(</span>
        <span class="token string">&quot;Congratulations, you are a member of %s now.&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>
            app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'SITE_NAME'</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        body<span class="token operator">=</span><span class="token string">'Please click the link: %s'</span> <span class="token operator">%</span> get_verification_link<span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">,</span>
        sender<span class="token operator">=</span><span class="token string">&quot;noreply@example.com&quot;</span><span class="token punctuation">,</span>
        recipients<span class="token operator">=</span><span class="token punctuation">[</span>user<span class="token punctuation">.</span>email<span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
    mail<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/users/register/success'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">register_account_success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    send_account_verification_mail<span class="token punctuation">.</span>delay<span class="token punctuation">(</span>g<span class="token punctuation">.</span>user<span class="token punctuation">)</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'users/register/success.html'</span><span class="token punctuation">)</span>
</code></pre></div><p>The code has changed not much:</p> <ul><li>A new library is added for managing tasks. Celery (<a href="http://www.celeryproject.org/" target="_blank" rel="noopener noreferrer">http://www.celeryproject.org/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>) is an asynchronous queue library.</li> <li>The function <code>send_account_verification_mail</code> is wrapped by a decorator <code>@celery.task()</code>.</li> <li>The call of the function becomes <code>send_account_verification_mail.delay(g.user)</code>.</li></ul> <p>On the operation side, two significant components are added:</p> <ul><li>A message queue. In this case, it's a rabbitmq process.</li> <li>Worker. In this case, it's a celery worker.</li></ul> <p>After the change, the web process that handles users' requests can respond immediately. The worker process will send emails if a new task is detected. The long-running tasks is thus moved to the worker process. Message queue with a live worker makes sure that the task is executed shortly and won't block the user request.</p> <p>If you have a lot of user registrations, the worker can process all of email sending tasks one by one, though some delay might be expected.</p> <p>There are more use cases for using message queue, such as image cropping, video encoding, publishing notifications to many subscribers, etc.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/soasme/enqueuezero/edit/master/build-up/message-queue-use-case.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5635613a.js" defer></script><script src="/assets/js/6.34f786ca.js" defer></script><script src="/assets/js/62.473c2104.js" defer></script>
  </body>
</html>
