(window.webpackJsonp=window.webpackJsonp||[]).push([[30],{419:function(e,t,a){"use strict";a.r(t);var s=a(54),n=Object(s.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"dns-load-balance"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dns-load-balance"}},[e._v("#")]),e._v(" DNS Load Balance")]),e._v(" "),a("h2",{attrs:{id:"context"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#context"}},[e._v("#")]),e._v(" Context")]),e._v(" "),a("p",[e._v("DNS, or Domain Name System, is the yellow page of the Internet. When people access to the website through domain name "),a("code",[e._v("enqueuezero.com")]),e._v(", the web browser interacts with DNS server first to get the IP addresses for dialing.")]),e._v(" "),a("p",[a("RouterLink",{attrs:{to:"/load-balance.html"}},[e._v("Load Balance")]),e._v(" is essential for distributing traffic across multiple hosts in the server farm.")],1),e._v(" "),a("p",[e._v("DNS Load Balancing provides the most straightforward load balancing strategy through DNS servers.")]),e._v(" "),a("h2",{attrs:{id:"overview"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#overview"}},[e._v("#")]),e._v(" Overview")]),e._v(" "),a("p",[e._v("DNS load balancing is an implementation of configuring the IP addresses of the domain name as multiple A records. As a result, the requests from the client are distributed across a group of server machines.")]),e._v(" "),a("p",[e._v("For example, "),a("a",{attrs:{href:"https://enqueuezero.com",target:"_blank",rel:"noopener noreferrer"}},[e._v("enqueuezero.com"),a("OutboundLink")],1),e._v(" has 4 IP addresses that can serve requests - "),a("code",[e._v("185.199.108.153")]),e._v(", "),a("code",[e._v("185.199.109.153")]),e._v(", "),a("code",[e._v("185.199.110.153")]),e._v(", "),a("code",[e._v("185.199.111.153")]),e._v(". We can configure multiple A records for "),a("code",[e._v("enqueuezero.com")]),e._v(" in the domain name provider. In this case, it's Google Domains.  Below screenshot shows how to configure A records in Google Domains:")]),e._v(" "),a("p",[a("img",{attrs:{src:"/static/images/dns-load-balancing-setting.png",alt:"Google Domains"}})]),e._v(" "),a("p",[e._v("Below command shows, the DNS interrogation gets 4 IP addresses.")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("% dig enqueuezero.com\n\n; <<>> DiG 9.10.6 <<>> enqueuezero.com\n;; global options: +cmd\n;; Got answer:\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 61900\n;; flags: qr rd ra; QUERY: 1, ANSWER: 4, AUTHORITY: 0, ADDITIONAL: 1\n\n;; OPT PSEUDOSECTION:\n; EDNS: version: 0, flags:; udp: 512\n;; QUESTION SECTION:\n;enqueuezero.com.        IN    A\n\n;; ANSWER SECTION:\nenqueuezero.com.    599    IN    A    185.199.108.153\nenqueuezero.com.    599    IN    A    185.199.109.153\nenqueuezero.com.    599    IN    A    185.199.110.153\nenqueuezero.com.    599    IN    A    185.199.111.153\n\n;; Query time: 260 msec\n;; SERVER: 8.8.4.4#53(8.8.4.4)\n;; WHEN: Tue Dec 25 07:55:24 NZDT 2018\n;; MSG SIZE  rcvd: 108\n")])])]),a("p",[e._v("To prove such configuration can distribute traffics, let's ping the domain in different servers. As you can see, the ping command talks to servers in different IP addresses based on where the ping starts, as the DNS server returns the host that responds the fastest.")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("# From Auckland, NZ\n$ ping -c 1 enqueuezero.com\nPING enqueuezero.com (185.199.108.153): 56 data bytes\n64 bytes from 185.199.108.153: icmp_seq=0 ttl=60 time=43.267 ms\n")])])]),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("# From CA, US\n$ ping -c 1 enqueuezero.com\nPING enqueuezero.com (185.199.111.153): 56 data bytes\n64 bytes from 185.199.111.153: icmp_seq=0 ttl=60 time=52.162 ms\n")])])]),a("p",[e._v("Short conclusion: By configuring multiple A records for the domain, DNS load balancing can distribute traffic across multiple server hosts.")]),e._v(" "),a("h2",{attrs:{id:"solutions"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#solutions"}},[e._v("#")]),e._v(" Solutions")]),e._v(" "),a("h3",{attrs:{id:"terraform"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#terraform"}},[e._v("#")]),e._v(" Terraform")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://www.terraform.io/docs/providers/dns/index.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("Terraform DNS provider"),a("OutboundLink")],1),e._v(" supports any DNS provider that supports DNS updates (RFC 2136).")]),e._v(" "),a("p",[e._v("You can apply multiple IP addresses to the resource "),a("code",[e._v("dns_a_record_set")]),e._v(" like below.")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('resource "dns_a_record_set" "@" {\n  zone = "enqueuezero.com."\n  name = "@"\n  addresses = [\n    "185.199.108.153",\n    "185.199.109.153",\n    "185.199.110.153",\n    "185.199.111.153",\n  ]\n  ttl = 300\n}\n')])])]),a("p",[e._v("You can also use "),a("a",{attrs:{href:"https://www.terraform.io/docs/providers/aws/r/route53_record.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("Terraform AWS route53"),a("OutboundLink")],1),e._v(" if you're using AWS Route53 for load balancing, or "),a("a",{attrs:{href:"https://www.terraform.io/docs/providers/azurerm/r/dns_a_record.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("Terraform Azure DNS resources"),a("OutboundLink")],1),e._v(" if you're using Azure service. Below code shows how to utilize AWS Route53 for DNS load balancing.")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('resource "aws_route53_record" "www" {\n  zone_id = "${aws_route53_zone.primary.zone_id}"\n  name    = "enqueuezero.com"\n  type    = "A"\n  ttl     = "300"\n  records = ["${aws_eip.lb.public_ip}"]\n}\n')])])]),a("h3",{attrs:{id:"externaldns"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#externaldns"}},[e._v("#")]),e._v(" ExternalDNS")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/kubernetes-incubator/external-dns",target:"_blank",rel:"noopener noreferrer"}},[e._v("github.com"),a("OutboundLink")],1)]),e._v(" "),a("p",[e._v("ExternalDNS makes Kubernetes resources discoverable via public DNS servers.")]),e._v(" "),a("p",[e._v("After setting IAM policies and a hosted zone, you can apply below resource to the Kubernetes cluster.")]),e._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" extensions/v1beta1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" Deployment\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" external"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("dns\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("strategy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" Recreate\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("template")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" external"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("dns\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" external"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("dns\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" registry.opensource.zalan.do/teapot/external"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("dns"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("latest\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("args")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("source=service\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("source=ingress\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("domain"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("filter=external"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("dns"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("test.my"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("org.com "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# will make ExternalDNS see only the hosted zones matching provided domain, omit to process all available hosted zones")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("provider=aws\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("policy=upsert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("only "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# would prevent ExternalDNS from deleting any records, omit to enable full synchronization")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("aws"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("zone"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("type=public "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# only look at public hosted zones (valid values are public, private or no value for both)")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("registry=txt\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("txt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("owner"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("id=my"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("identifier\n")])])]),a("p",[e._v("When the "),a("code",[e._v("external-dns")]),e._v(" pod is up, it will add the Ingress service IP addresses to the DNS in the hosted zone. Check the full tutorial of setting ExternalDNS up: "),a("a",{attrs:{href:"https://github.com/kubernetes-incubator/external-dns/blob/master/docs/tutorials/aws.md",target:"_blank",rel:"noopener noreferrer"}},[e._v("github.com/kubernetes-incubator/external-dns"),a("OutboundLink")],1)]),e._v(" "),a("p",[e._v("The reason we can't see IP addresses in this example is the external-dns exposes dynamic public IP addresses of the ingress service assigned by the overlay network IP manager.")]),e._v(" "),a("h2",{attrs:{id:"patterns"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#patterns"}},[e._v("#")]),e._v(" Patterns")]),e._v(" "),a("h3",{attrs:{id:"seeming-round-robin"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#seeming-round-robin"}},[e._v("#")]),e._v(" Seeming Round-Robin")]),e._v(" "),a("p",[e._v("You cannot set any round robin algorithms to the scheduler (DNS server) since it is not defined in the DNS protocol. However, the traffic is distributed to the servers in a seeming round-robin way.")]),e._v(" "),a("p",[e._v("The DNS cache on specific DNS server node deviates the stats. It happens when the DNS results are cached on a DNS server, and unfortunately, this DNS server serves more traffic than others. Things like geography, population distribution, city size, infrastructure can affect the")]),e._v(" "),a("h3",{attrs:{id:"performance"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#performance"}},[e._v("#")]),e._v(" Performance")]),e._v(" "),a("p",[e._v("There is no much performance issue when the traffic grows when applying the DNS load balancing,\nsince the DNS caching system works so well.")]),e._v(" "),a("p",[e._v("From an operational perspective, engineering teams can collect and monitor the DNS latencies from different regions. The popular tools includes "),a("a",{attrs:{href:"https://worldping.raintank.io/",target:"_blank",rel:"noopener noreferrer"}},[e._v("worldPing"),a("OutboundLink")],1),e._v(", "),a("a",{attrs:{href:"https://www.pingdom.com/",target:"_blank",rel:"noopener noreferrer"}},[e._v("PingDom"),a("OutboundLink")],1),e._v(", etc.")]),e._v(" "),a("h3",{attrs:{id:"scale"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#scale"}},[e._v("#")]),e._v(" Scale")]),e._v(" "),a("p",[e._v("When the number of the servers in the farm goes up, we can add more A records to the domain.\nThere is no limitation of the number of the records.")]),e._v(" "),a("p",[e._v("In practical, we can mix using the A record and CNAME group records.")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("enqueuezero.com.    599    IN    CNAME    lb1.enqueuezero.com\nenqueuezero.com.    599    IN    CNAME    lb2.enqueuezero.com\nlb1.enqueuezero.com.    599    IN    A    185.199.108.153\nlb1.enqueuezero.com.    599    IN    A    185.199.109.153\nlb2.enqueuezero.com.    599    IN    A    185.199.110.153\nlb2.enqueuezero.com.    599    IN    A    185.199.111.153\n")])])]),a("h3",{attrs:{id:"fail-over"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#fail-over"}},[e._v("#")]),e._v(" Fail Over")]),e._v(" "),a("p",[e._v("Setting a proper TTL for DNS records is essential. It's the number of the seconds that the DNS records expire. When one of the backend hosts is down, it's critical to modify the DNS records as soon as possible.")]),e._v(" "),a("p",[e._v("The DDNS or Standard Dynamic update DNS (RFC 2126) enables updates for the DNS records remotely. The other DNS providers might provide HTTP APIs for updating the DNS records.")]),e._v(" "),a("p",[e._v("Tools like ExternalDNS can listen to the Kubernetes API events and automatically updates the DNS records when ingress services get updated.")]),e._v(" "),a("h2",{attrs:{id:"conclusions"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#conclusions"}},[e._v("#")]),e._v(" Conclusions")]),e._v(" "),a("p",[e._v("DNS load balancing distributes requests across multiple IP addresses by configuring various DNS A records. Modern tools enable programmatically updating DNS records. When the incident happens, some of them can even automatically update the DNS records. The downside of DNS load balancing is that it cannot distribute requests evenly to the backend servers.")]),e._v(" "),a("h2",{attrs:{id:"references"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#references"}},[e._v("#")]),e._v(" References")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://en.wikipedia.org/wiki/Domain_Name_System",target:"_blank",rel:"noopener noreferrer"}},[e._v("Domain Name System"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://www.nginx.com/resources/glossary/dns-load-balancing/",target:"_blank",rel:"noopener noreferrer"}},[e._v("What Is DNS Load Balancing?"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=n.exports}}]);