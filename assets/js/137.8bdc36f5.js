(window.webpackJsonp=window.webpackJsonp||[]).push([[137],{519:function(t,s,e){"use strict";e.r(s);var a=e(54),n=Object(a.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"zeromq-message"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#zeromq-message"}},[t._v("#")]),t._v(" ZeroMQ Message")]),t._v(" "),e("p",[t._v("The implementation of ZeroMQ message is an artifact of engineering solutions. It takes trade-offs between "),e("em",[t._v("high performance")]),t._v(".and various "),e("em",[t._v("use cases")]),t._v(".")]),t._v(" "),e("p",[t._v("It's never easy to get high performance considering that premature optimization is the root of all evil. We should find a right timing and a right spot optimizing the software. Yet ZeroMQ made it well.  Based on the size of the content, ZeroMQ allocates small messages (vsm) and large messages (lmsg). Small messages encode the content in itself, while large messages reference the content to an user allocated memory. When the size is large, ZeroMQ needs user provide an "),e("code",[t._v("ffn")]),t._v(" function to deallocate the content, as it's user's responsibility to do clean up work for the memory of large contents. Such design is efficient enough for almost all use cases and yields to relatively small code set. Below code shows how ZeroMQ initialize a message:")]),t._v(" "),e("div",{staticClass:"language-cpp extra-class"},[e("pre",{pre:!0,attrs:{class:"language-cpp"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("size_ "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<=")]),t._v(" max_vsm_size"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    u"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("vsm"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" type_vsm"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    u"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("vsm"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("size "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" size_"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ... (other fields).")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    u"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lmsg"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" type_lmsg"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    u"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lmsg"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("content "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("content_t"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("malloc")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("content_t"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" size_"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    u"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lmsg"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("content"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("data "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" u"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lmsg"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("content "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    u"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lmsg"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("content"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("size "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" size_"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    u"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lmsg"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("content"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("ffn "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ... (other fields)")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("In order to support various message types, such as storing the content in the message itself, storing the content in user allocated memory, pointing the content to the constant data, etc, ZeroMQ designs slightly different structs to represent them, and tightly packs all structs into a union. It makes sure one message can have only one type and one interpretation of its meaning. For example, to get the content from a message, a simple switch-case solves the problem:")]),t._v(" "),e("div",{staticClass:"language-cpp extra-class"},[e("pre",{pre:!0,attrs:{class:"language-cpp"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("switch")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("u"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("base"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("          "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// u is the union, and all common fields can be accessed by `base`.")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" type_vsm"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("                  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// typ_vsm indicates a small message.")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" u"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("vsm"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("          "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// for small message, we access data from field `data`.")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" type_lmsg"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("                 "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// type_lmsg indicates a large message.")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" u"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lmsg"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("content"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("data"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// for large message, we use pointer.")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ... (other types) ")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("If you're interested in how ZeroMQ is implemented, check "),e("a",{attrs:{href:"https://github.com/zeromq/libzmq/blob/master/src/msg.hpp",target:"_blank",rel:"noopener noreferrer"}},[t._v("msg.hpp"),e("OutboundLink")],1),t._v(" and "),e("a",{attrs:{href:"https://github.com/zeromq/libzmq/blob/master/src/msg.cpp",target:"_blank",rel:"noopener noreferrer"}},[t._v("msg.cpp"),e("OutboundLink")],1),t._v(".")])])}),[],!1,null,null,null);s.default=n.exports}}]);